# Telegram-бот Salyk Finance — добавление транзакции

Бот с простым сценарием: привязка аккаунта по коду → выбор доход/расход → ввод суммы → подтверждение. Транзакция появляется в веб-кабинете пользователя.

---

## Flow (сценарий)

1. **`/start`**  
   - Если аккаунт уже привязан → приветствие и предложение добавить транзакцию (кнопки «Доход» / «Расход»).  
   - Если не привязан → сообщение «Привяжите аккаунт» и запрос кода (код пользователь берёт в веб-кабинете).

2. **Привязка по коду**  
   - Пользователь вводит код (например, 6 цифр).  
   - Бот отправляет код на бэкенд; бэкенд связывает `telegram_id` с пользователем и возвращает успех/ошибку.  
   - После успеха показываем кнопки «Доход» / «Расход».

3. **Выбор типа**  
   - Inline или Reply-кнопки: **Доход** / **Расход**.

4. **Ввод суммы**  
   - Запрос: «Введите сумму» (число, с копейками при необходимости).  
   - Валидация: положительное число, при необходимости лимит.

5. **Подтверждение**  
   - Показ: «Доход 500 сом. Подтвердить?» и кнопки **Да** / **Отмена**.  
   - При «Да» — запрос `POST /api/finance/transactions/` от имени пользователя.  
   - Ответ: «Транзакция добавлена» и предложение добавить ещё или выйти в меню.

---



## Нюансы и упрощения (первая версия)

- **Категория:** в боте можно не выбирать категорию — в API поле `category` опционально (`null`). Позже можно добавить шаг «Выберите категорию» или «По умолчанию».
- **Дата:** транзакция с датой «сегодня» (`transaction_date` = текущая дата).
- **Налоги/бизнес:** для простоты первая версия: `is_business=False`, `is_taxable=True`, `activity_code=null`, `payment_method=cash`. При необходимости потом добавить выбор «наличные/безнал» и т.д.
- **Повторная привязка:** один `telegram_id` уже привязан к одному пользователю (unique). Если пользователь хочет привязать другой Telegram — в веб-кабинете «Отвязать» (очистить `telegram_id`) и привязать заново новым кодом.
- **Безопасность:** эндпоинты привязки и выдачи токена для бота должны проверять секрет бота (`X-Bot-Secret` или аналог), чтобы только наш бот мог ими пользоваться.

---

## Запуск (после появления API на бэке)

```bash
cd tg_bot
python -m venv venv
venv\Scripts\activate   # Windows
pip install -r requirements.txt
# Скопировать config.example.env в .env и заполнить BOT_TOKEN, API_BASE
python run_bot.py
```

---

## Структура папки

```
tg_bot/
  README.md           — этот файл (flow, требования к бэку, нюансы)
  requirements.txt    — зависимости
  config.example.env  — пример переменных окружения (скопировать в .env)
  states.py           — FSM-состояния бота
  api_client.py       — обёртка над API (привязка, токен, создание транзакции)
  bot.py              — обработчики и запуск бота
  run_bot.py          — точка входа
```

Пока на бэкенде нет эндпоинтов привязки и выдачи токена для бота:
- по `/start` бот предложит ввести код привязки;
- при вводе кода пользователь увидит сообщение о том, что «привязка пока недоступна».
После добавления API в `api_client.py` нужно раскомментировать вызовы и при необходимости поправить URL/поля.
