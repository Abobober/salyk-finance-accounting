# Telegram-бот Salyk Finance — добавление транзакции

Бот с простым сценарием: привязка аккаунта по коду → выбор доход/расход → ввод суммы → подтверждение. Транзакция появляется в веб-кабинете пользователя.

---

## Flow (сценарий)

1. **`/start`**  
   - Если аккаунт уже привязан → приветствие и предложение добавить транзакцию (кнопки «Доход» / «Расход»).  
   - Если не привязан → сообщение «Привяжите аккаунт» и запрос кода (код пользователь берёт в веб-кабинете).

2. **Привязка по коду**  
   - Пользователь вводит код (например, 6 цифр).  
   - Бот отправляет код на бэкенд; бэкенд связывает `telegram_id` с пользователем и возвращает успех/ошибку.  
   - После успеха показываем кнопки «Доход» / «Расход».

3. **Выбор типа**  
   - Inline или Reply-кнопки: **Доход** / **Расход**.

4. **Ввод суммы**  
   - Запрос: «Введите сумму» (число, с копейками при необходимости).  
   - Валидация: положительное число, при необходимости лимит.

5. **Подтверждение**  
   - Показ: «Доход 500 сом. Подтвердить?» и кнопки **Да** / **Отмена**.  
   - При «Да» — запрос `POST /api/finance/transactions/` от имени пользователя.  
   - Ответ: «Транзакция добавлена» и предложение добавить ещё или выйти в меню.

---

## Что нужно от бэкенда (без этого бот не сможет работать полностью)

Сейчас в `CustomUser` уже есть поле `telegram_id`. Не хватает API для привязки и авторизации бота.

### 1. Генерация кода привязки (в веб-кабинете)

- Пользователь в личном кабинете нажимает «Привязать Telegram».
- **Новый эндпоинт**, например:  
  `POST /api/users/telegram-link-code/` (требует JWT).  
- Ответ: `{ "code": "123456", "expires_at": "..." }` (код живёт 5–10 минут).  
- В БД: временная таблица или кэш (Redis/БД): `code → user_id`, `expires_at`.

### 2. Привязка по коду (вызывает бот)

- **Новый эндпоинт**, например:  
  `POST /api/bot/link/` (без JWT, но с секретом бота или без — см. ниже).  
- Тело: `{ "code": "123456", "telegram_id": "123456789" }`.  
- Логика: найти пользователя по `code`, проверить срок действия, записать у пользователя `telegram_id`, удалить/инвалидировать код.  
- Ответ: `200 OK` или ошибка (код неверный/истёк).

### 3. Выдача JWT для бота (чтобы бот ходил в API от имени пользователя)

- Сейчас все запросы к `/api/finance/*` требуют JWT (`IsAuthenticated`).  
- Варианты:
  - **Вариант A.** Отдельный эндпоинт для бота:  
    `POST /api/bot/auth/` с телом `{ "telegram_id": "123456789" }` и заголовком `X-Bot-Secret: <секрет из .env>`.  
    Бэкенд проверяет секрет, находит пользователя по `telegram_id`, выдаёт пару access/refresh (как `/api/token/`).  
  - **Вариант B.** Тот же `POST /api/bot/link/` в ответ на успешную привязку возвращает одноразовый или долгоживущий токен для бота (тогда бот сохраняет его и использует для запросов).

После появления этих эндпоинтов в `api_client.py` нужно будет только подставить реальные URL и вызовы.

---

## Нюансы и упрощения (первая версия)

- **Категория:** в боте можно не выбирать категорию — в API поле `category` опционально (`null`). Позже можно добавить шаг «Выберите категорию» или «По умолчанию».
- **Дата:** транзакция с датой «сегодня» (`transaction_date` = текущая дата).
- **Налоги/бизнес:** для простоты первая версия: `is_business=False`, `is_taxable=True`, `activity_code=null`, `payment_method=cash`. При необходимости потом добавить выбор «наличные/безнал» и т.д.
- **Повторная привязка:** один `telegram_id` уже привязан к одному пользователю (unique). Если пользователь хочет привязать другой Telegram — в веб-кабинете «Отвязать» (очистить `telegram_id`) и привязать заново новым кодом.
- **Безопасность:** эндпоинты привязки и выдачи токена для бота должны проверять секрет бота (`X-Bot-Secret` или аналог), чтобы только наш бот мог ими пользоваться.

---

## Запуск (после появления API на бэке)

```bash
cd tg_bot
python -m venv venv
venv\Scripts\activate   # Windows
pip install -r requirements.txt
# Скопировать config.example.env в .env и заполнить BOT_TOKEN, API_BASE
python run_bot.py
```

---

## Структура папки

```
tg_bot/
  README.md           — этот файл (flow, требования к бэку, нюансы)
  requirements.txt    — зависимости
  config.example.env  — пример переменных окружения (скопировать в .env)
  states.py           — FSM-состояния бота
  api_client.py       — обёртка над API (привязка, токен, создание транзакции)
  bot.py              — обработчики и запуск бота
  run_bot.py          — точка входа
```

Пока на бэкенде нет эндпоинтов привязки и выдачи токена для бота:
- по `/start` бот предложит ввести код привязки;
- при вводе кода пользователь увидит сообщение о том, что «привязка пока недоступна».
После добавления API в `api_client.py` нужно раскомментировать вызовы и при необходимости поправить URL/поля.
